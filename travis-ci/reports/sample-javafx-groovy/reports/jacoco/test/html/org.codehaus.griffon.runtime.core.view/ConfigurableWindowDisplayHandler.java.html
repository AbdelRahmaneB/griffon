<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>ConfigurableWindowDisplayHandler.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">sample-javafx-groovy</a> &gt; <a href="index.source.html" class="el_package">org.codehaus.griffon.runtime.core.view</a> &gt; <span class="el_source">ConfigurableWindowDisplayHandler.java</span></div><h1>ConfigurableWindowDisplayHandler.java</h1><pre class="source lang-java linenums">/*
 * Copyright 2008-2015 the original author or authors.
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package org.codehaus.griffon.runtime.core.view;

import griffon.core.CallableWithArgs;
import griffon.core.GriffonApplication;
import griffon.core.view.WindowDisplayHandler;
import griffon.exceptions.InstanceNotFoundException;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import javax.annotation.Nonnull;
import javax.annotation.Nullable;
import javax.inject.Inject;
import javax.inject.Named;
import java.util.Collections;
import java.util.Map;

import static griffon.util.AnnotationUtils.named;
import static griffon.util.ConfigUtils.getConfigValue;
import static griffon.util.GriffonNameUtils.requireNonBlank;
import static java.util.Objects.requireNonNull;

/**
 * Implementation of a per window {@code WindowDisplayHandler} that can be configured via a DSL.&lt;p&gt;
 * This is the default {@code WindowDisplayHandler} used by {@code SwingApplication}. It expects a configuration
 * entry in &lt;code&gt;griffon-app/conf/Config.groovy&lt;/code&gt; that looks like the following one&lt;p&gt;
 * &lt;pre&gt;
 *     windowManager {
 *         myWindowName = [
 *             show: {name, window -&gt; ... },
 *             hide: {name, window -&gt; ... }
 *         ]
 *         myOtherWindowName = [
 *             show: {name, window -&gt; ... }
 *         ]
 *     }
 * &lt;/pre&gt;
 * &lt;p/&gt;
 * For these settings to work you must specify a &lt;code&gt;name:&lt;/code&gt; property on the Window/Frame instance. This
 * {@code WindowDisplayHandler} is smart enough to use the default show/hide behavior should any or both are not specified
 * or if a window name does not have a matching configuration. The default behavior will also be used if the Window/Frame
 * does not have a value for its &lt;code&gt;name:&lt;/code&gt; property.&lt;p&gt;
 * There's a third option that can be set for each configured window, and that is a delegate {@code WindowDisplayHandler} that
 * will be used for that window alone. The following example shows how it can be configured&lt;p&gt;
 * &lt;pre&gt;
 *     windowManager {
 *         myWindowName = [
 *             handler: new MyCustomWindowDisplayHandler()
 *         ]
 *         myOtherWindowName = [
 *             show: {name, window -&gt; ... }
 *         ]
 *     }
 * &lt;/pre&gt;
 * &lt;p/&gt;
 * Lastly, a global handler can be specified for all windows that have not been configured. If specified, this handler will
 * override the usage of the default one. It can be configured as follows&lt;p&gt;
 * &lt;pre&gt;
 *     windowManager {
 *         defaultHandler = new MyCustomWindowDisplayHandler()
 *         myOtherWindowName = [
 *             show: {name, window -&gt; ... }
 *         ]
 *     }
 * &lt;/pre&gt;
 * &lt;p/&gt;
 * Fine grained control for default &lt;code&gt;show&lt;/code&gt; and &lt;code&gt;hide&lt;/code&gt; is also possible, by specifying &lt;code&gt;defaultShow&lt;/code&gt;
 * and/or &lt;code&gt;defaultHide&lt;/code&gt; properties at the global level. These properties take precedence over &lt;code&gt;defaultHandler&lt;/code&gt; .
 * &lt;p/&gt;
 * &lt;pre&gt;
 *     windowManager {
 *         defaultHide = {name, window -&gt; ... }
 *         myOtherWindowName = [
 *             show: {name, window -&gt; ... }
 *         ]
 *     }
 * &lt;/pre&gt;
 * &lt;p/&gt;
 * &lt;strong&gt;Note:&lt;/strong&gt; the value for &lt;code&gt;show&lt;/code&gt; and &lt;code&gt;hide&lt;/code&gt; can be either a Closure or a {@code RunnableWithArgs}.
 *
 * @author Andres Almiray
 * @since 2.0.0
 */
public class ConfigurableWindowDisplayHandler&lt;W&gt; implements WindowDisplayHandler&lt;W&gt; {
<span class="fc" id="L99">    private static final Logger LOG = LoggerFactory.getLogger(ConfigurableWindowDisplayHandler.class);</span>

    protected static final String ERROR_NAME_BLANK = &quot;Argument 'name' must not be blank&quot;;
    protected static final String ERROR_WINDOW_NULL = &quot;Argument 'window' must not be null&quot;;

    private final GriffonApplication application;
    private final WindowDisplayHandler&lt;W&gt; delegateWindowsDisplayHandler;

    @Inject
<span class="fc" id="L108">    public ConfigurableWindowDisplayHandler(@Nonnull GriffonApplication application, @Nonnull @Named(&quot;defaultWindowDisplayHandler&quot;) WindowDisplayHandler&lt;W&gt; delegateWindowsDisplayHandler) {</span>
<span class="fc" id="L109">        this.application = requireNonNull(application, &quot;Argument 'application' must not be null&quot;);</span>
<span class="fc" id="L110">        this.delegateWindowsDisplayHandler = requireNonNull(delegateWindowsDisplayHandler, &quot;Argument 'delegateWindowsDisplayHandler' must not be null&quot;);</span>
<span class="fc" id="L111">    }</span>

    @SuppressWarnings(&quot;unchecked&quot;)
    public void show(@Nonnull String name, @Nonnull W window) {
<span class="nc" id="L115">        requireNonBlank(name, ERROR_NAME_BLANK);</span>
<span class="nc" id="L116">        requireNonNull(window, ERROR_WINDOW_NULL);</span>

<span class="nc" id="L118">        Map&lt;String, Object&gt; options = windowBlock(name);</span>
<span class="nc bnc" id="L119" title="All 2 branches missed.">        if (!options.isEmpty()) {</span>
<span class="nc" id="L120">            Object handler = options.get(&quot;show&quot;);</span>
<span class="nc bnc" id="L121" title="All 2 branches missed.">            if (canBeRun(handler)) {</span>
<span class="nc" id="L122">                LOG.trace(&quot;Showing {} with show: handler&quot;, name);</span>
<span class="nc" id="L123">                run(handler, name, window);</span>
<span class="nc" id="L124">                return;</span>
<span class="nc bnc" id="L125" title="All 2 branches missed.">            } else if (options.get(&quot;handler&quot;) instanceof WindowDisplayHandler) {</span>
<span class="nc" id="L126">                LOG.trace(&quot;Showing {} with handler: handler&quot;, name);</span>
<span class="nc" id="L127">                ((WindowDisplayHandler&lt;W&gt;) options.get(&quot;handler&quot;)).show(name, window);</span>
<span class="nc" id="L128">                return;</span>
            }
        }

<span class="nc bnc" id="L132" title="All 2 branches missed.">        if (handleShowByInjectedHandler(name, window)) {</span>
<span class="nc" id="L133">            return;</span>
        }

<span class="nc" id="L136">        options = windowManagerBlock();</span>
<span class="nc bnc" id="L137" title="All 2 branches missed.">        if (!options.isEmpty()) {</span>
<span class="nc" id="L138">            Object defaultShow = options.get(&quot;defaultShow&quot;);</span>
<span class="nc bnc" id="L139" title="All 2 branches missed.">            if (canBeRun(defaultShow)) {</span>
<span class="nc" id="L140">                LOG.trace(&quot;Showing {} with defaultShow: handler&quot;, name);</span>
<span class="nc" id="L141">                run(defaultShow, name, window);</span>
<span class="nc" id="L142">                return;</span>
            }
        }

<span class="nc" id="L146">        LOG.trace(&quot;Showing {} with default handler&quot;, name);</span>
<span class="nc" id="L147">        fetchDefaultWindowDisplayHandler().show(name, window);</span>
<span class="nc" id="L148">    }</span>

    @SuppressWarnings(&quot;unchecked&quot;)
    public void hide(@Nonnull String name, @Nonnull W window) {
<span class="nc" id="L152">        requireNonBlank(name, ERROR_NAME_BLANK);</span>
<span class="nc" id="L153">        requireNonNull(window, ERROR_WINDOW_NULL);</span>

<span class="nc" id="L155">        Map&lt;String, Object&gt; options = windowBlock(name);</span>
<span class="nc bnc" id="L156" title="All 2 branches missed.">        if (!options.isEmpty()) {</span>
<span class="nc" id="L157">            Object handler = options.get(&quot;hide&quot;);</span>
<span class="nc bnc" id="L158" title="All 2 branches missed.">            if (canBeRun(handler)) {</span>
<span class="nc" id="L159">                LOG.trace(&quot;Hiding {} with hide: handler&quot;, name);</span>
<span class="nc" id="L160">                run(handler, name, window);</span>
<span class="nc" id="L161">                return;</span>
<span class="nc bnc" id="L162" title="All 2 branches missed.">            } else if (options.get(&quot;handler&quot;) instanceof WindowDisplayHandler) {</span>
<span class="nc" id="L163">                LOG.trace(&quot;Hiding {} with handler: handler&quot;, name);</span>
<span class="nc" id="L164">                ((WindowDisplayHandler&lt;W&gt;) options.get(&quot;handler&quot;)).hide(name, window);</span>
<span class="nc" id="L165">                return;</span>
            }
        }

<span class="nc bnc" id="L169" title="All 2 branches missed.">        if (handleHideByInjectedHandler(name, window)) {</span>
<span class="nc" id="L170">            return;</span>
        }

<span class="nc" id="L173">        options = windowManagerBlock();</span>
<span class="nc bnc" id="L174" title="All 2 branches missed.">        if (!options.isEmpty()) {</span>
<span class="nc" id="L175">            Object defaultHide = options.get(&quot;defaultHide&quot;);</span>
<span class="nc bnc" id="L176" title="All 2 branches missed.">            if (canBeRun(defaultHide)) {</span>
<span class="nc" id="L177">                LOG.trace(&quot;Hiding {} with defaultHide: handler&quot;, name);</span>
<span class="nc" id="L178">                run(defaultHide, name, window);</span>
<span class="nc" id="L179">                return;</span>
            }
        }

<span class="nc" id="L183">        LOG.trace(&quot;Hiding {} with default handler&quot;, name);</span>
<span class="nc" id="L184">        fetchDefaultWindowDisplayHandler().hide(name, window);</span>
<span class="nc" id="L185">    }</span>

    @SuppressWarnings(&quot;unchecked&quot;)
    protected boolean handleShowByInjectedHandler(@Nonnull String name, @Nonnull W window) {
        try {
<span class="nc" id="L190">            WindowDisplayHandler&lt;W&gt; handler = getApplication().getInjector()</span>
<span class="nc" id="L191">                .getInstance(WindowDisplayHandler.class, named(name));</span>
<span class="nc" id="L192">            LOG.trace(&quot;Showing {} with injected handler&quot;, name);</span>
<span class="nc" id="L193">            handler.show(name, window);</span>
<span class="nc" id="L194">            return true;</span>
<span class="nc" id="L195">        } catch (InstanceNotFoundException infe) {</span>
            // ignore
        }
<span class="nc" id="L198">        return false;</span>
    }

    @SuppressWarnings(&quot;unchecked&quot;)
    protected boolean handleHideByInjectedHandler(@Nonnull String name, @Nonnull W window) {
        try {
<span class="nc" id="L204">            WindowDisplayHandler&lt;W&gt; handler = getApplication().getInjector()</span>
<span class="nc" id="L205">                .getInstance(WindowDisplayHandler.class, named(name));</span>
<span class="nc" id="L206">            LOG.trace(&quot;Hiding {} with injected handler&quot;, name);</span>
<span class="nc" id="L207">            handler.hide(name, window);</span>
<span class="nc" id="L208">            return true;</span>
<span class="nc" id="L209">        } catch (InstanceNotFoundException infe) {</span>
            // ignore
        }
<span class="nc" id="L212">        return false;</span>
    }

    public WindowDisplayHandler&lt;W&gt; getDelegateWindowsDisplayHandler() {
<span class="nc" id="L216">        return delegateWindowsDisplayHandler;</span>
    }

    protected boolean canBeRun(@Nullable Object obj) {
<span class="nc" id="L220">        return obj instanceof CallableWithArgs;</span>
    }

    protected void run(@Nonnull Object handler, @Nonnull String name, @Nonnull W window) {
<span class="nc bnc" id="L224" title="All 2 branches missed.">        if (handler instanceof CallableWithArgs) {</span>
<span class="nc" id="L225">            ((CallableWithArgs&lt;?&gt;) handler).call(name, window);</span>
        }
<span class="nc" id="L227">    }</span>

    protected Map&lt;String, Object&gt; windowManagerBlock() {
<span class="nc" id="L230">        return application.getConfiguration().get(&quot;windowManager&quot;, Collections.&lt;String, Object&gt;emptyMap());</span>
    }

    protected Map&lt;String, Object&gt; windowBlock(String windowName) {
<span class="nc" id="L234">        Map&lt;String, Object&gt; options = windowManagerBlock();</span>
<span class="nc" id="L235">        return getConfigValue(options, windowName, Collections.&lt;String, Object&gt;emptyMap());</span>
    }

    protected GriffonApplication getApplication() {
<span class="nc" id="L239">        return application;</span>
    }

    @Nonnull
    @SuppressWarnings(&quot;unchecked&quot;)
    protected WindowDisplayHandler&lt;W&gt; fetchDefaultWindowDisplayHandler() {
<span class="nc" id="L245">        Object handler = windowManagerBlock().get(&quot;defaultHandler&quot;);</span>
<span class="nc bnc" id="L246" title="All 2 branches missed.">        return handler instanceof WindowDisplayHandler ? (WindowDisplayHandler&lt;W&gt;) handler : delegateWindowsDisplayHandler;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.3.201502191951</span></div></body></html>