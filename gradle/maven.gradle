import groovy.xml.NamespaceBuilder
import org.apache.tools.ant.filters.ReplaceTokens

/*
buildscript {
    repositories {
        mavenCentral()
    }
    dependencies {
        classpath "org.apache.maven.wagon:wagon-webdav:1.0-beta-2",
                  "org.apache.maven:maven-ant-tasks:2.1.0"
    }
}
*/

configurations {
    deployerJars
}
repositories {
    mavenCentral()
}
dependencies {
    deployerJars "org.apache.maven.wagon:wagon-webdav:1.0-beta-2",
                 "org.apache.maven:maven-ant-tasks:2.1.0"
}

task generatePoms(type: Copy) {
    pomsDir = "$buildDir/poms"
    from('src/poms') {
        include '*.pom.in'
        filter(ReplaceTokens, tokens: ['griffon.version': version])
        rename '(.*)\\.in', '$1'
    }
    into pomsDir
}

mavenArtifacts = tasks.withType(Jar).matching({task -> task.mavenArtifact } as Spec)

task mavenInstall(dependsOn: [generatePoms, mavenArtifacts.all]) << {
    ant.taskdef(resource: 'org/apache/maven/artifact/ant/antlib.xml',
                uri: 'antlib:org.apache.maven.artifact.ant',
                classpath: configurations.deployerJars.asPath)
    def artifact = NamespaceBuilder.newInstance(ant, 'antlib:org.apache.maven.artifact.ant')

    mavenArtifacts.each {jar ->
        artifact.install(file: jar.archivePath) {
            pom(file: "$generatePoms.pomsDir/$jar.baseName${jar.appendix ? '-' + jar.appendix : ""}.pom")
        }
    }
    
/*
    // install the griffon parent POM
    artifact.install(file: "${libs.destinationDir}/griffon-${version}.jar") {
        pom(file: "$generatePoms.pomsDir/griffon.pom")
    }
*/
}

/*
task mavenDeploy(dependsOn: [generatePoms, tasks.withType(Jar).all]) << {
    def antBuilderClasspath = services.get(org.gradle.api.internal.ClassPathRegistry).getClassPathFiles('ANT') +
    services.get(org.gradle.api.internal.ClassPathRegistry).getClassPathFiles('LOCAL_GROOVY') + 
    configurations.deployerJars.files
    def isolatedAnt = services.get(org.gradle.api.internal.project.IsolatedAntBuilder)
    
    tasks.withType(Jar).matching({task -> task.mavenArtifact } as Spec).each {jar ->
        isolatedAnt.execute(antBuilderClasspath) {
            'antlib:org.apache.maven.artifact.ant:deploy'(file: jar.archivePath) {
                pom(file: "$generatePoms.pomsDir/$jar.baseName${jar.appendix ? '-' + jar.appendix : ""}.pom")
            }
        }
    }
    // deploy the griffon parent POM
    isolatedAnt.execute(antBuilderClasspath) {
    'antlib:org.apache.maven.artifact.ant:deploy'(file: "${libs.destinationDir}/griffon-${version}.jar") {
        pom(file:"$generatePoms.pomsDir/griffon.pom")
     }
   }
}
*/
